// Prisma schema for dual-mode deployment (SQLite for desktop, PostgreSQL for Docker)

generator client {
  provider  = "prisma-client-py"
  interface = "asyncio"
}

datasource db {
  provider = "postgresql" // Change to "postgresql" for Docker mode
  url      = env("DATABASE_URL")
}

// User model - supports both license key (desktop) and password (docker) authentication
model User {
  id           String  @id @default(uuid())
  externalId   String  @unique // Clerk User ID
  email        String  @unique
  firstName    String?
  lastName     String?
  imageUrl     String?
  name         String? // Full name (optional)
  passwordHash String? // For Docker mode
  licenseKey   String? @unique // For Desktop mode
  role         Role    @default(USER)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // AI Credits (Personal trial credits)
  creditBalance Int @default(5)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  projects           Project[]
  findings           Finding[]
  reports            Report[]
  aiUsageLogs        AiUsageLog[]
  projectMemberships ProjectMember[] // Project team memberships

  @@index([email])
  @@index([licenseKey])
  @@index([externalId])
}

enum Role {
  ADMIN
  USER
  VIEWER
}

// Organization model for multi-tenancy (Docker mode)
model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique
  plan Plan   @default(FREE)

  // Paddle Billing Integration
  paddleCustomerId   String?             @unique // Paddle's customer ID
  subscriptionId     String?             @unique // Active Paddle subscription ID
  subscriptionStatus SubscriptionStatus? // Subscription state from Paddle
  updateUrl          String? // Paddle URL to update payment method
  cancelUrl          String? // Paddle URL to cancel subscription

  // AI Credits (Organization-level)
  creditBalance Int @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  clients     Client[]
  templates   Template[]
  aiUsageLogs AiUsageLog[]

  @@index([slug])
  @@index([paddleCustomerId])
  @@index([subscriptionId])
}

enum Plan {
  FREE
  PRO
  AGENCY
}

enum SubscriptionStatus {
  active
  past_due
  trialing
  paused
  canceled
}

// License validation table (Desktop mode)
model License {
  id              String    @id @default(uuid())
  licenseKey      String    @unique
  machineId       String?
  activatedAt     DateTime?
  lastValidatedAt DateTime?
  expiresAt       DateTime?
  isActive        Boolean   @default(true)

  plan        Plan @default(FREE)
  maxProjects Int  @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([licenseKey])
  @@index([machineId])
}

// Client model
model Client {
  id           String  @id @default(uuid())
  name         String
  code         String?  // Client ticker code for finding IDs (e.g., "ACME" for "Acme Corp")
  contactName  String?
  contactEmail String?
  contactPhone String?
  address      String?
  
  // Additional client info
  industry     String?
  companySize  String?  // 'Enterprise', 'SMB', 'Startup'
  websiteUrl   String?
  status       String?  @default("Prospect") // 'Active', 'Inactive', 'Prospect'
  riskLevel    String?  @default("Medium")   // 'High', 'Medium', 'Low'
  tags         String?  // JSON array stored as string
  notes        String?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
  
  // Track finding counter for sequential IDs
  findingCounter Int @default(0)  // Current highest finding number for this client

  @@index([organizationId])
  @@index([code])
}

// Project model
model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  startDate   DateTime?
  endDate     DateTime?
  
  // Project configuration
  projectType   String?  // External, Internal, Web App, Mobile, API, Cloud, Network
  scope         String?  // JSON array of scope items
  methodology   String?  // Testing methodology
  complianceFrameworks String?  // JSON array of compliance frameworks
  priority      String?  @default("Medium") // Low, Medium, High, Critical

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  leadId String
  lead   User   @relation(fields: [leadId], references: [id])

  // Retest relationship
  isRetest        Boolean  @default(false)  // True if this project is a retest
  parentProjectId String?  // Reference to the original project (if this is a retest)
  parentProject   Project? @relation("ProjectRetests", fields: [parentProjectId], references: [id])
  retests         Project[] @relation("ProjectRetests")  // Child retest projects

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  findings Finding[]
  reports  Report[]
  members  ProjectMember[] // Team members with roles

  @@index([clientId])
  @@index([leadId])
  @@index([status])
  @@index([parentProjectId])
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  REVIEW
  COMPLETED
  ARCHIVED
  ON_HOLD
  CANCELLED
}

enum ProjectRole {
  LEAD
  TESTER
  VIEWER
}

// Project Member model (Join table for project team membership)
model ProjectMember {
  id        String      @id @default(uuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      ProjectRole @default(TESTER)
  assignedAt DateTime  @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId]) // Prevent duplicate memberships
  @@index([projectId])
  @@index([userId])
  @@index([role])
}

// Finding model
model Finding {
  id          String   @id @default(uuid())
  referenceId String?  @unique // Professional ID like "ACM-001"
  title       String
  description String // Rich text content
  severity    Severity
  cvssScore   Float?
  cvssVector  String?
  cveId       String?

  affectedSystems     String?
  affectedAssetsCount Int     @default(0) // Count of affected assets
  affectedAssetsJson  String? // JSON array of affected assets [{url, description, instanceCount}]
  evidence            String? // Rich text content for PoC/Evidence
  remediation         String? // Rich text content
  references          String? // JSON array of URLs

  status FindingStatus @default(OPEN)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])

  // Import source tracking (e.g., "burp", "nessus", "manual")
  source   String?
  sourceId String? // Original ID from the import source

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  evidences Evidence[]

  @@index([projectId])
  @@index([severity])
  @@index([status])
  @@index([cveId])
  @@index([referenceId])
  @@index([source])
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum FindingStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  ACCEPTED
  FALSE_POSITIVE
}

// Evidence model (screenshots, files)
model Evidence {
  id       String  @id @default(uuid())
  filename String
  filepath String
  filesize Int
  mimetype String
  caption  String?

  findingId String
  finding   Finding @relation(fields: [findingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([findingId])
}

// Report model
model Report {
  id         String       @id @default(uuid())
  title      String
  reportType ReportType   @default(PENTEST)
  status     ReportStatus @default(DRAFT)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  generatedById String
  generatedBy   User   @relation(fields: [generatedById], references: [id])

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])

  pdfPath     String?
  htmlContent String? // Cached HTML

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  generatedAt DateTime?

  @@index([projectId])
  @@index([status])
}

enum ReportType {
  PENTEST
  VULNERABILITY_ASSESSMENT
  COMPLIANCE
  EXECUTIVE_SUMMARY
}

enum ReportStatus {
  DRAFT
  GENERATING
  COMPLETED
  FAILED
}

// Template model (for findings and reports)
model Template {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        TemplateType
  content     String // JSON or HTML content

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  isPublic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  findings Finding[]
  reports  Report[]

  @@index([type])
  @@index([organizationId])
}

enum TemplateType {
  FINDING
  REPORT
}

// Sync metadata for desktop-cloud synchronization
model SyncMetadata {
  id           String   @id @default(uuid())
  entityType   String // "finding", "project", etc.
  entityId     String
  lastSyncedAt DateTime
  syncHash     String // Hash of entity data
  cloudId      String? // ID in cloud database

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId])
  @@index([entityType])
  @@index([cloudId])
}

// AI Usage Log (Audit trail for AI credit consumption)
model AiUsageLog {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  action   String // e.g., "generate_report", "ai_rewrite", "cve_lookup"
  cost     Int // Credits consumed
  metadata String? // JSON with additional context

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
}

// Audit Log (Security and compliance audit trail)
// SECURITY: Tracks all user actions for compliance and security monitoring
model AuditLog {
  id        String   @id @default(uuid())
  timestamp DateTime @default(now())
  
  // Who performed the action
  userId    String?  // May be null for unauthenticated actions (e.g., failed login)
  userEmail String?  // Cached for historical reference
  
  // What action was performed
  action    AuditAction
  
  // What resource was affected
  resource     String   // e.g., "Finding", "Client", "Project", "User"
  resourceId   String?  // ID of the affected resource
  resourceName String?  // Human-readable name (for reports)
  
  // Action details
  details   String?  // JSON with before/after values or context
  
  // Request context
  ipAddress String?
  userAgent String?
  requestId String?  // For correlating with logs
  
  // Organization context
  organizationId String?
  
  // Outcome
  success   Boolean @default(true)
  errorMsg  String? // Error message if action failed
  
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([resourceId])
  @@index([timestamp])
  @@index([organizationId])
  @@index([ipAddress])
}

enum AuditAction {
  // CRUD operations
  CREATE
  READ
  UPDATE
  DELETE
  
  // Authentication
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  TOKEN_REFRESH
  
  // Security events
  RATE_LIMITED
  ACCESS_DENIED
  INVALID_INPUT
  
  // Import/Export
  IMPORT
  EXPORT
  DOWNLOAD
  
  // Admin actions
  ROLE_CHANGE
  SETTINGS_CHANGE
}
